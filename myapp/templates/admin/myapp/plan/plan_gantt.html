{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
    {{ block.super }}
    {# Cargar CSS de Frappe Gantt (usando CDN como ejemplo) #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        /* Estilos básicos para el contenedor del Gantt */
        .gantt-container {
            margin-top: 20px;
            overflow: auto; /* Para scroll si es necesario */
        }
        /* Ajustar estilos de Frappe si es necesario para que encaje con Semantic UI */
        .gantt .bar-label {
             font-size: 11px; /* O 0.8rem, ajusta según veas necesario */
             fill: #333; /* Color oscuro para legibilidad */
        }
    </style>
{% endblock %}

{% block content %}
    {# Título ya viene de la plantilla base usando 'title' del contexto #}

    {# Opcional: Formulario para seleccionar el año #}
    <form method="get" class="ui form">
        <div class="inline field">
            <label for="year-select">Seleccionar Año:</label>
            <input type="number" name="year" id="year-select" value="{{ selected_year }}" min="2020" max="2100">
            <button type="submit" class="ui mini primary button">Ver Año</button>
        </div>
    </form>

    {# Contenedor donde se renderizará el Gantt #}
    <div class="gantt-container">
        <svg id="gantt"></svg> {# Frappe Gantt usa SVG #}
    </div>

{% endblock %}

{% block extrascript %}
    {{ block.super }}
    {# Cargar JS de Frappe Gantt (usando CDN como ejemplo) #}
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener los datos JSON pasados desde la vista Django
            var tasks = JSON.parse('{{ gantt_data_json|escapejs }}');

            if (tasks && tasks.length > 0) {
                // Inicializar Frappe Gantt
                var gantt = new Gantt("#gantt", tasks, {
                    // --- Opciones de Configuración ---
                    header_height: 50,
                    column_width: 30,
                    step: 24, // Horas en un día
                    view_modes: ['Day', 'Week', 'Month'], // Modos de vista disponibles
                    bar_height: 20,
                    bar_corner_radius: 3,
                    arrow_curve: 5,
                    padding: 18,
                    view_mode: 'Month', // Modo de vista inicial
                    date_format: 'YYYY-MM-DD',
                    language: 'es', // Establecer idioma si está disponible (puede requerir archivo de idioma)
                    custom_popup_html: function(task) {
                        // Popup personalizado al hacer hover (opcional)
                        return `
                            <div class="details-container" style="padding: 5px; font-size: 0.9rem;">
                            <h5>${task.name}</h5>
                            <p>Fecha: ${task.start}</p>
                            {# Puedes añadir más detalles aquí si los pasas en el JSON #}
                            </div>
                        `;
                    },
                    // on_click: function (task) { ... }, // Asegurarse que on_click esté comentado o eliminado
                    // on_date_change: function(task, start, end) { ... }, // Para drag & drop
                    // on_progress_change: function(task, progress) { ... }, // Si se edita progreso
                    // on_view_change: function(mode) { ... } // Al cambiar modo de vista
                });
                console.log("Gantt inicializado.");
            } else {
                // Mostrar mensaje si no hay tareas para el año/filtro
                document.getElementById('gantt').innerHTML = '<p class="ui info message">No hay tareas de plan para mostrar para este año o filtro.</p>';
                console.log("No hay tareas para mostrar en el Gantt.");
            }
        });
    </script>
{% endblock %}
