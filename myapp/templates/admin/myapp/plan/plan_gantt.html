{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
    {{ block.super }}
    {# Incluir CSS de Frappe Gantt (desde CDN o static) #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        /* Estilos básicos para el contenedor y SVG */
        .gantt-container {
            margin-top: 20px;
            overflow-x: auto; /* Permite scroll horizontal si el Gantt es ancho */
        }
        #gantt .grid-header,
        #gantt .grid-row {
             fill: #f9f9f9; /* Fondo claro para las filas */
        }
        #gantt .grid-row:nth-child(odd) {
             fill: #ffffff; /* Fondo alterno si quieres */
        }
        #gantt .bar-label {
             font-size: 11px; /* O 0.8rem, ajusta según veas necesario */
             fill: #333; /* Color oscuro para legibilidad */
        }
        /* --- Nuevos Estilos para Estados --- */
        /* Estilo para tareas ejecutadas (cambia el color de la barra) */
        .gantt-task-executed .bar-progress {
            fill: #21ba45 !important; /* Verde Semantic UI */
        }
        .gantt-task-executed .bar-wrapper {
             /* Puedes añadir más estilos, como un borde */
        }
        /* Estilo para tareas pendientes (puedes dejar el default o cambiarlo) */
        .gantt-task-pending .bar-progress {
            fill: #fbbd08 !important; /* Amarillo/Naranja Semantic UI */
        }
        /* --- Fin Nuevos Estilos --- */

        /* Estilo para el selector de año */
        .year-selector-form {
            margin-bottom: 15px;
        }
    </style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>

    {# Formulario para seleccionar el año #}
    <form method="get" class="year-selector-form ui form">
        <div class="inline field">
            <label for="year-select">Seleccionar Año:</label>
            <select name="year" id="year-select" class="ui dropdown" onchange="this.form.submit()">
                {% for year in available_years %}
                    <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% empty %}
                    <option value="">No hay años disponibles</option>
                {% endfor %}
            </select>
            {# Botón opcional si no quieres que cambie automáticamente #}
            {# <button type="submit" class="ui primary button">Ver Gantt</button> #}
        </div>
    </form>

    {# Contenedor para el diagrama de Gantt #}
    <div class="gantt-container">
        <svg id="gantt"></svg>
    </div>
</div>
{% endblock %}

{% block extrajs %}
    {{ block.super }}
    {# Incluir JS de Frappe Gantt (desde CDN o static) #}
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener los datos JSON pasados desde la vista
            var ganttData = {{ gantt_data_json|safe }};

            if (ganttData && ganttData.length > 0) {
                // Inicializar Frappe Gantt
                var gantt = new Gantt("#gantt", ganttData, {
                    header_height: 50,
                    column_width: 30,
                    step: 24, // Horas en un día
                    view_modes: ['Day', 'Week', 'Month'], // Modos de vista disponibles
                    bar_height: 20,
                    bar_corner_radius: 3,
                    arrow_curve: 5,
                    padding: 18,
                    view_mode: 'Month', // Modo de vista inicial
                    date_format: 'YYYY-MM-DD',
                    language: 'es', // Establecer idioma si está disponible (puede requerir archivo de idioma)
                    custom_popup_html: function(task) {
                        // Popup personalizado al hacer hover
                        // Accedemos a los datos extra pasados desde la vista
                        const executed_on = task.custom_popup_data ? task.custom_popup_data.executed_on : 'N/A';
                        const status_text = task.custom_popup_data ? task.custom_popup_data.status_text : 'Desconocido';
                        return `
                            <div class="details-container" style="padding: 5px; font-size: 0.9rem; min-width: 200px;">
                                <h5 style="margin-bottom: 5px;">${task.name}</h5>
                                <p style="margin-bottom: 3px;"><strong>Fecha Programada:</strong> ${task.start}</p>
                                <p style="margin-bottom: 0;"><strong>Estado:</strong> ${status_text} ${status_text === 'Ejecutado' ? '(' + executed_on + ')' : ''}</p>
                                {# Puedes añadir más detalles aquí si los pasas en el JSON #}
                            </div>
                        `;
                    },
                    on_click: function (task) {
                        // Acción al hacer clic en una tarea (opcional)
                        console.log("Tarea clickeada:", task);
                        // Podrías redirigir a la vista de detalle del Plan si quieres
                        // window.location.href = `/admin/myapp/plan/${task.id}/change/`;
                    },
                    on_date_change: function(task, start, end) {
                        // Acción si se permite arrastrar/cambiar fechas (deshabilitado por defecto)
                        console.log("Fecha cambiada:", task, start, end);
                    },
                    on_progress_change: function(task, progress) {
                        // Acción si se permite cambiar el progreso (deshabilitado por defecto)
                        console.log("Progreso cambiado:", task, progress);
                    },
                    on_view_change: function(mode) {
                        // Acción cuando cambia el modo de vista (Day, Week, Month)
                        console.log("Modo de vista cambiado:", mode);
                    }
                });
            } else {
                // Mostrar mensaje si no hay datos para el año seleccionado
                var ganttContainer = document.querySelector('.gantt-container');
                if (ganttContainer) {
                    ganttContainer.innerHTML = '<p>No hay planes programados para el año seleccionado.</p>';
                }
            }
        });
    </script>
{% endblock %}
