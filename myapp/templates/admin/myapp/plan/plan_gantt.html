{% extends "base.html" %}
{% load static %}

{% block title %}Diagrama de Gantt 2 - Plan de Cumplimiento{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        /* Ajustar tamaño de fuente y cursor para indicar click */
        .gantt .bar-label {
            font-size: 11px; /* Un poco más pequeño para que quepa más texto */
            fill: #333; /* Color de texto más oscuro */
        }
        .gantt .bar-wrapper {
             cursor: pointer; /* Cursor de mano al pasar sobre la barra */
        }
        /* Optional: Custom styles for the Gantt chart */
        .gantt .bar-milestone .bar {
            fill: #6c757d; /* Example: Grey color for milestones */
        }
        .gantt-container {
            overflow: auto; /* Add scrollbars if needed */
            padding: 20px;
        }
        svg {
            display: block; /* Prevent extra space below SVG */
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Diagrama de Gantt - Plan de Cumplimiento</h2>
    <p>Haz clic en una tarea para ver/editar sus detalles.</p> {# Mensaje añadido #}

    <div class="gantt-container">
        <svg id="gantt"></svg>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener las tareas desde el contexto de Django (¡importante el |safe!)
            var tasks = {{ tasks_json|safe }}; // Get tasks from context

            if (tasks.length > 0) {
                var gantt = new Gantt("#gantt", tasks, {
                    header_height: 50,
                    column_width: 30,
                    step: 24,
                    view_modes: ['Day', 'Week', 'Month'], // Available view modes
                    bar_height: 20,
                    bar_corner_radius: 3,
                    arrow_curve: 5,
                    padding: 18,
                    view_mode: 'Month', // Default view mode
                    date_format: 'YYYY-MM-DD',
                    language: 'es', // Set language if available, otherwise defaults to English
                    custom_popup_html: null, // Disable default popup if using on_click

                    // --- Manejador de evento para clic en tarea ---
                    on_click: function (task) {
                        console.log("Clicked task:", task); // Para depuración
                        if (task.admin_url) {
                            // Si la tarea tiene la URL del admin, navegar a ella
                            window.location.href = task.admin_url;
                        } else {
                            console.log("No admin_url found for this task.");
                        }
                    },
                    // --- Event handler for date change (optional) ---
                    on_date_change: function(task, start, end) {
                        console.log("Date changed for task:", task.id, start, end);
                        // You might want to send an update to the server here if you allow dragging
                    },
                    // --- Event handler for progress change (optional) ---
                    on_progress_change: function(task, progress) {
                        console.log("Progress changed for task:", task.id, progress);
                        // You might want to send an update to the server here
                    },
                    // --- Event handler for viewing change (optional) ---
                    on_view_change: function(mode) {
                        console.log("View mode changed to:", mode);
                    }
                });
            } else {
                // Optional: Display a message if there are no tasks
                document.getElementById('gantt').innerHTML = '<p>No hay tareas planificadas para mostrar en el Gantt para la empresa seleccionada.</p>';
            }
        });
    </script>
{% endblock %}
