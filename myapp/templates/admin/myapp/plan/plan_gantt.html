{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %} {# Añadido admin_urls e i18n para consistencia #}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        .gantt-filters {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
        }
        .gantt-filters label {
            margin-right: 8px;
            font-weight: bold;
        }
        .gantt-filters select,
        .gantt-filters input[type="submit"] {
            padding: .375rem .75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: .25rem;
            border: 1px solid #ced4da;
            margin-right: 15px;
        }
        .gantt-filters input[type="submit"] {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
            cursor: pointer;
        }
        .gantt-filters input[type="submit"]:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .gantt-chart-container {
            margin-top: 20px;
            overflow-x: auto; /* Para scroll horizontal si el gantt es muy ancho */
        }
        #gantt .bar-wrapper { cursor: pointer; } /* Para indicar que las barras son clickeables si tienes popups */
    </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">Inicio</a> &rsaquo;
<a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a> &rsaquo;
<a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a> &rsaquo;


{{ title }}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>

    <div class="gantt-filters">
        <form method="get" action="">
            <label for="year-select">Año:</label>
            <select name="year" id="year-select">
                {# Iterar sobre year_options pasadas desde la vista #}
                {% for year_opt in year_options %}
                    <option value="{{ year_opt }}" {% if year_opt == selected_year %}selected{% endif %}>
                        {{ year_opt }}
                    </option>
                {% endfor %}
            </select>

            <label for="responsable-select">Responsable:</label>
            <select name="responsable_id" id="responsable-select">
                <option value="" {% if selected_responsable_id == "" or selected_responsable_id is None %}selected{% endif %}>Todos los Responsables</option>
                {% for responsable in responsables_disponibles %}
                    <option value="{{ responsable.id }}" {% if responsable.id == selected_responsable_id %}selected{% endif %}>
                        {{ responsable.get_full_name|default:responsable.username }}
                    </option>
                {% endfor %}
            </select>

            <input type="submit" value="Filtrar">
        </form>
    </div>

    <div class="gantt-chart-container">
        <svg id="gantt"></svg>
    </div>
</div>
{% endblock %}

{% block extrajs %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var tasksJson = '{{ gantt_data_json|escapejs }}';
            var tasks = [];
            try {
                tasks = JSON.parse(tasksJson);
            } catch (e) {
                console.error("Error al parsear JSON de tareas:", e);
                document.getElementById('gantt').innerHTML = '<p style="color:red;">Error al cargar los datos de las tareas.</p>';
                return;
            }

            if (tasks && tasks.length > 0) {
                var gantt = new Gantt("#gantt", tasks, {
                    header_height: 60, // Aumentado para mejor visualización de modos
                    column_width: 35,  // Ancho de columna
                    step: 24, // Un día
                    view_modes: ['Day', 'Week', 'Month', 'Year'], // Modos de vista disponibles
                    bar_height: 25,    // Altura de la barra
                    bar_corner_radius: 5,
                    arrow_curve: 5,
                    padding: 20,
                    view_mode: 'Week', // Modo de vista inicial
                    date_format: 'YYYY-MM-DD',
                    language: 'es', 
                    custom_popup_html: function(task) {
                        // Popup personalizado mejorado
                        let html = `
                            <div class="gantt-popup" style="padding:15px; font-size:13px; min-width: 250px;">
                                <strong style="display:block; margin-bottom:8px; font-size:15px;">${task.name}</strong>
                                <p style="margin:4px 0;"><strong>Inicio:</strong> ${task.start}</p>
                                <p style="margin:4px 0;"><strong>Fin:</strong> ${task.end}</p>
                                <p style="margin:4px 0;"><strong>Progreso:</strong> ${task.progress}%</p>
                            </div>
                        `;
                        // Puedes añadir más información si la pasas en el JSON de tareas
                        // Por ejemplo: task.responsables (si lo añades al JSON)
                        return html;
                    },
                    on_click: function (task) {
                        console.log("Tarea clickeada:", task);
                        // Podrías redirigir al detalle del plan si tienes una URL para ello
                        // window.location.href = `/admin/myapp/plan/${task.id}/change/`;
                    },
                    on_date_change: function(task, start, end) {
                        console.log("Fecha cambiada (drag/resize):", task, start, end);
                        // Aquí podrías implementar lógica para guardar cambios si permites edición
                    },
                    on_progress_change: function(task, progress) {
                        console.log("Progreso cambiado:", task, progress);
                        // Lógica para guardar cambios de progreso
                    }
                });
            } else {
                document.getElementById('gantt').innerHTML = '<p>No hay tareas para mostrar con los filtros seleccionados.</p>';
            }
        });
    </script>
{% endblock %}
